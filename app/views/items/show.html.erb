<div class="row">
  <!-- Main Content -->
  <div class="col-lg-8">
    <!-- Item Image -->
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-body p-0">
        <% if @item.image.attached? %>
          <%= image_tag @item.image, class: "img-fluid w-100", style: "max-height: 600px; object-fit: cover;", alt: @item.title %>
        <% else %>
          <div class="d-flex align-items-center justify-content-center bg-light" style="height: 400px;">
            <div class="text-center">
              <i class="bi bi-image display-1 text-muted"></i>
              <p class="text-muted mt-2">No image available</p>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Item Details -->
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-header bg-white border-bottom">
        <h2 class="card-title mb-0 fw-bold"><%= @item.title %></h2>
      </div>
      <div class="card-body">
        <div class="mb-4">
          <h5 class="fw-semibold mb-3">
            <i class="bi bi-info-circle me-2 text-primary"></i>Description
          </h5>
          <p class="text-muted" style="white-space: pre-wrap;"><%= @item.description.present? ? @item.description : "No description provided." %></p>
        </div>

        <hr>

        <!-- Item Information Grid -->
        <div class="row g-3">
          <div class="col-md-6">
            <div class="d-flex align-items-center">
              <i class="bi bi-tag-fill text-primary me-2 fs-5"></i>
              <div>
                <small class="text-muted d-block">Category</small>
                <strong><%= @item.category.present? ? @item.category : "Not specified" %></strong>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex align-items-center">
              <i class="bi bi-person-circle text-primary me-2 fs-5"></i>
              <div>
                <small class="text-muted d-block">Owner</small>
                <strong><%= @item.owner.username || @item.owner.email %></strong>
              </div>
            </div>
          </div>
          <% if @item.available_from.present? || @item.available_to.present? %>
            <div class="col-md-6">
              <div class="d-flex align-items-center">
                <i class="bi bi-calendar-check text-primary me-2 fs-5"></i>
                <div>
                  <small class="text-muted d-block">Available From</small>
                  <strong><%= @item.available_from.present? ? @item.available_from.strftime("%B %d, %Y") : "Not specified" %></strong>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex align-items-center">
                <i class="bi bi-calendar-x text-primary me-2 fs-5"></i>
                <div>
                  <small class="text-muted d-block">Available Until</small>
                  <strong><%= @item.available_to.present? ? @item.available_to.strftime("%B %d, %Y") : "Not specified" %></strong>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="col-lg-4">
    <!-- Pricing Card -->
    <div class="card shadow-sm border-0 mb-4 sticky-top" style="top: 20px; z-index: 1020;">
      <div class="card-body">
        <div class="text-center mb-4">
          <div class="display-4 fw-bold text-primary mb-2">
            <%= number_to_currency(@item.price) %>
          </div>
          <p class="text-muted mb-0">per day</p>
          <% if @item.deposit_amount.present? && @item.deposit_amount > 0 %>
            <div class="mt-3 pt-3 border-top">
              <small class="text-muted d-block">Deposit</small>
              <div class="fw-bold text-info">
                <%= number_to_currency(@item.deposit_amount) %>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Payment Methods -->
        <div class="mb-3">
          <small class="text-muted d-block mb-2">Accepted Payment Methods:</small>
          <div class="d-flex flex-wrap gap-2">
            <% if @item.payment_methods == "credit_card" || @item.payment_methods == "both" %>
              <span class="badge bg-primary">
                <i class="bi bi-credit-card me-1"></i>Credit Card
              </span>
            <% end %>
            <% if @item.payment_methods == "cash" || @item.payment_methods == "both" %>
              <span class="badge bg-success">
                <i class="bi bi-cash-coin me-1"></i>Cash
              </span>
            <% end %>
          </div>
        </div>

        <div class="mb-3">
          <span class="badge bg-<%= @item.availability_status == 'available' ? 'success' : @item.availability_status == 'pending' ? 'warning' : 'secondary' %> fs-6 px-3 py-2 w-100 d-block text-center">
            <i class="bi bi-<%= @item.availability_status == 'available' ? 'check-circle' : @item.availability_status == 'pending' ? 'clock' : 'x-circle' %> me-2"></i>
            <%= @item.availability_status.capitalize %>
          </span>
        </div>

        <% if user_signed_in? %>
          <% if current_user.id != @item.owner_id %>
            <%= link_to "Request to Rent", new_booking_path(item_id: @item.id), class: "btn btn-primary btn-lg w-100 mb-2" %>
            <button class="btn btn-outline-danger w-100 mb-2" data-bs-toggle="collapse" data-bs-target="#reportForm">
              <i class="bi bi-flag me-2"></i>Report Listing
            </button>
            <div class="collapse" id="reportForm">
              <div class="card card-body border-danger mb-2">
                <div id="report-status" class="alert d-none mb-3"></div>
                <h6 class="fw-bold mb-2">Report this listing</h6>
                <form id="report-listing-form">
                  <div class="mb-2">
                    <label class="form-label">Reason</label>
                    <select name="reason" class="form-select" required>
                      <option value="">Select a reason</option>
                      <option value="Fraud or scam">Fraud or scam</option>
                      <option value="Inappropriate content">Inappropriate content</option>
                      <option value="Safety concern">Safety concern</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Details</label>
                    <textarea name="details" class="form-control" rows="3" placeholder="Add details to help admins review" required></textarea>
                  </div>
                  <input type="hidden" name="itemID" value="<%= @item.id %>">
                  <button type="submit" class="btn btn-danger w-100">
                    Submit Report
                  </button>
                  <div class="small text-muted mt-2">
                    Reports are reviewed by admins. You can track status in your dashboard.
                  </div>
                </form>
              </div>
            </div>
          <% else %>
            <!-- Owner Actions -->
            <div class="d-grid gap-2">
              <%= link_to edit_item_path(@item), class: "btn btn-outline-primary btn-lg w-100 mb-2" do %>
                <i class="bi bi-pencil me-2"></i>Edit Listing
              <% end %>
              <%= button_to item_path(@item), method: :delete,
                  class: "btn btn-outline-danger btn-lg w-100",
                  data: { confirm: "Are you sure you want to delete this listing? This action cannot be undone." } do %>
                <i class="bi bi-trash me-2"></i>Delete Listing
              <% end %>
            </div>
          <% end %>
        <% else %>
          <%= link_to "Sign In to Rent", new_user_session_path, class: "btn btn-primary btn-lg w-100 mb-2" %>
        <% end %>

        <hr>

        <div class="small text-muted">
          <p class="mb-2">
            <i class="bi bi-shield-check me-2"></i>Secure booking process
          </p>
          <p class="mb-2">
            <i class="bi bi-chat-dots me-2"></i>Message the owner directly
          </p>
          <p class="mb-0">
            <i class="bi bi-clock-history me-2"></i>Flexible rental periods
          </p>
        </div>
      </div>
    </div>

    <!-- Admin Actions -->
    <% if user_signed_in? && current_user.role == 'admin' %>
      <div class="card shadow-sm border-0 border-danger">
        <div class="card-header bg-danger text-white">
          <h6 class="mb-0">
            <i class="bi bi-shield-exclamation me-2"></i>Admin Actions
          </h6>
        </div>
        <div class="card-body">
          <%= button_to "Remove Listing", admin_item_path(@item), method: :delete,
              class: "btn btn-danger w-100",
              data: { confirm: "Are you sure you want to remove this listing? This action cannot be undone." } %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Back Button -->
<div class="mt-4">
  <%= link_to items_path, class: "btn btn-outline-secondary" do %>
    <i class="bi bi-arrow-left me-2"></i>Back to Browse
  <% end %>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("report-listing-form");
    if (!form) return;

    const token = document.querySelector("meta[name='csrf-token']")?.content;
    const statusBox = document.getElementById("report-status");
    const submitBtn = form.querySelector("button[type='submit']");

    const showStatus = (type, message) => {
      if (!statusBox) return;
      statusBox.classList.remove("d-none", "alert-success", "alert-danger");
      statusBox.classList.add(type === "success" ? "alert-success" : "alert-danger", "show", "alert");
      statusBox.textContent = message;
    };

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());
      submitBtn.disabled = true;

      try {
        const res = await fetch("/api/v1/disputes", {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": token,
            "Accept": "application/json"
          },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (res.ok && data.success) {
          showStatus("success", "Report submitted. You can track status in your dashboard.");
          submitBtn.disabled = true;
          form.reset();
        } else {
          showStatus("error", data.error || "Failed to submit report.");
          submitBtn.disabled = false;
        }
      } catch (err) {
        showStatus("error", "Network error while submitting report.");
        submitBtn.disabled = false;
      } finally {
        // keep submit disabled on success to prevent duplicates; re-enable only on errors above
      }
    });
  });
</script>