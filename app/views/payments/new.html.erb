<div class="row">
  <div class="col-lg-8 mx-auto">
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-header bg-primary text-white">
        <h2 class="card-title mb-0">
          <i class="bi bi-credit-card me-2"></i>Payment for Booking
        </h2>
      </div>
      <div class="card-body p-4">
        <!-- Booking Summary -->
        <div class="card bg-light mb-4">
          <div class="card-body">
            <h5 class="fw-bold mb-3">
              <i class="bi bi-receipt me-2"></i>Booking Summary
            </h5>
            <div class="row g-3">
              <div class="col-md-6">
                <small class="text-muted d-block">Item</small>
                <strong><%= @item.title %></strong>
              </div>
              <div class="col-md-6">
                <small class="text-muted d-block">Rental Period</small>
                <strong><%= @days %> <%= @days == 1 ? 'day' : 'days' %></strong>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Breakdown -->
        <div class="card border-0 mb-4">
          <div class="card-body">
            <h5 class="fw-bold mb-3">
              <i class="bi bi-calculator me-2 text-primary"></i>Payment Breakdown
            </h5>
            <div class="table-responsive">
              <table class="table table-borderless">
                <tbody>
                  <tr>
                    <td class="text-muted">Rental Subtotal</td>
                    <td class="text-end fw-semibold"><%= number_to_currency(@rental_subtotal) %></td>
                  </tr>
                  <tr>
                    <td class="text-muted">Deposit</td>
                    <td class="text-end fw-semibold"><%= number_to_currency(@deposit_amount) %></td>
                  </tr>
                  <tr class="border-top">
                    <td class="fw-bold fs-5">Total</td>
                    <td class="text-end fw-bold fs-5 text-primary"><%= number_to_currency(@total) %></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Payment Methods Info -->
        <div class="card border-info mb-4">
          <div class="card-body">
            <h6 class="fw-bold mb-2">
              <i class="bi bi-info-circle me-2 text-info"></i>Accepted Payment Methods
            </h6>
            <div class="d-flex flex-wrap gap-2 mb-2">
              <% if @item.payment_methods == "credit_card" || @item.payment_methods == "both" %>
                <span class="badge bg-primary">
                  <i class="bi bi-credit-card me-1"></i>Credit Card
                </span>
              <% end %>
              <% if @item.payment_methods == "cash" || @item.payment_methods == "both" %>
                <span class="badge bg-success">
                  <i class="bi bi-cash-coin me-1"></i>Cash
                </span>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Payment Form -->
        <%= form_with url: booking_payments_path(@booking), scope: :payment, local: true, class: "needs-validation", novalidate: true do |f| %>
          <div class="mb-4">
            <%= f.label :payment_type, "Payment Type", class: "form-label fw-semibold" %>
            <%= f.select :payment_type,
                  options_for_select([
                    ["Deposit Only", "deposit"],
                    ["Rental Fee Only", "rental"],
                    ["Deposit + Rental (Full Payment)", "both"]
                  ]),
                  {},
                  { class: "form-select form-select-lg", required: true } %>
            <div class="form-text">
              <i class="bi bi-info-circle me-1"></i>
              Choose what you'd like to pay now. You can pay the deposit first and the rental fee later, or pay everything at once.
            </div>
          </div>

          <!-- Payment Method Selection -->
          <% if @item.payment_methods == "both" %>
            <div class="mb-4">
              <label class="form-label fw-semibold">Payment Method</label>
              <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="payment_method" id="payment_method_card" value="credit_card" checked>
                <label class="form-check-label" for="payment_method_card">
                  <i class="bi bi-credit-card me-2"></i>Credit Card
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="payment_method" id="payment_method_cash" value="cash">
                <label class="form-check-label" for="payment_method_cash">
                  <i class="bi bi-cash-coin me-2"></i>Cash (In-Person)
                </label>
              </div>
            </div>
          <% end %>

          <!-- Credit Card Information (if credit_card or both) -->
          <% if @item.payment_methods == "credit_card" || @item.payment_methods == "both" %>
            <div id="card-info-section" class="card border-primary mb-4 <%= 'd-none' if @item.payment_methods == 'both' %>">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                  <i class="bi bi-credit-card me-2"></i>Credit Card Information
                </h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-12">
                    <label class="form-label">Card Number</label>
                    <input type="text" class="form-control" placeholder="1234 5678 9012 3456" pattern="[0-9\s]{13,19}" maxlength="19" required>
                    <small class="form-text text-muted">Enter your 16-digit card number</small>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Expiry Date</label>
                    <input type="text" class="form-control" placeholder="MM/YY" pattern="[0-9]{2}/[0-9]{2}" maxlength="5" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">CVV</label>
                    <input type="text" class="form-control" placeholder="123" pattern="[0-9]{3,4}" maxlength="4" required>
                  </div>
                  <div class="col-12">
                    <label class="form-label">Cardholder Name</label>
                    <input type="text" class="form-control" placeholder="John Doe" required>
                  </div>
                </div>
              </div>
            </div>
          <% end %>

          <!-- Cash Payment Info (if cash or both) -->
          <% if @item.payment_methods == "cash" || @item.payment_methods == "both" %>
            <div id="cash-info-section" class="card border-success mb-4 <%= 'd-none' if @item.payment_methods == 'both' %>">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0">
                  <i class="bi bi-cash-coin me-2"></i>Cash Payment
                </h6>
              </div>
              <div class="card-body">
                <div class="alert alert-info mb-0">
                  <i class="bi bi-info-circle me-2"></i>
                  <strong>In-Person Cash Payment:</strong> You will pay the owner in cash when you pick up the item. 
                  Please coordinate with the owner to arrange a meeting time and location.
                </div>
              </div>
            </div>
          <% end %>

          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Important:</strong> Please ensure you have sufficient funds before submitting your payment.
          </div>

          <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <%= link_to "Cancel", booking_path(@booking), class: "btn btn-outline-secondary btn-lg me-md-2" %>
            <%= f.submit "Submit Payment", class: "btn btn-primary btn-lg px-5" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<% if @item.payment_methods == "both" %>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const cardRadio = document.getElementById('payment_method_card');
    const cashRadio = document.getElementById('payment_method_cash');
    const cardSection = document.getElementById('card-info-section');
    const cashSection = document.getElementById('cash-info-section');
    const form = document.querySelector('form.needs-validation');

    function togglePaymentSections() {
      if (cardRadio.checked) {
        cardSection.classList.remove('d-none');
        cashSection.classList.add('d-none');
        // Make card fields required
        cardSection.querySelectorAll('input').forEach(input => {
          input.setAttribute('required', 'required');
        });
      } else if (cashRadio.checked) {
        cardSection.classList.add('d-none');
        cashSection.classList.remove('d-none');
        // Remove required from card fields
        cardSection.querySelectorAll('input').forEach(input => {
          input.removeAttribute('required');
        });
      }
    }

    // Initialize on page load
    togglePaymentSections();

    cardRadio.addEventListener('change', togglePaymentSections);
    cashRadio.addEventListener('change', togglePaymentSections);

    // Handle form submission - prevent validation errors for hidden fields
    if (form) {
      form.addEventListener('submit', function(e) {
        // Remove required from hidden fields before validation
        if (cashRadio.checked) {
          cardSection.querySelectorAll('input').forEach(input => {
            input.removeAttribute('required');
          });
        }
      });
    }
  });
</script>
<% end %>
