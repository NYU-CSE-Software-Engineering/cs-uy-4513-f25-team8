<div class="row mb-4">
  <div class="col-12">
    <h1 class="display-5 fw-bold mb-2">
      <i class="bi bi-people me-2 text-primary"></i>User Management Dashboard
    </h1>
    <p class="text-muted">Manage users, view account status, and handle reports</p>
  </div>
</div>

<!-- Quick Links -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <div class="bg-info bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
              <i class="bi bi-envelope text-info fs-4"></i>
            </div>
          </div>
          <div class="flex-grow-1 ms-3">
            <h6 class="mb-0 fw-bold">Contact Messages</h6>
            <p class="text-muted mb-0 small">View user feedback and inquiries</p>
          </div>
          <div>
            <%= link_to admin_contacts_path, class: "btn btn-sm btn-outline-info" do %>
              <i class="bi bi-arrow-right"></i>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <div class="bg-warning bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
              <i class="bi bi-flag text-warning fs-4"></i>
            </div>
          </div>
          <div class="flex-grow-1 ms-3">
            <h6 class="mb-0 fw-bold">Open Reports</h6>
            <p class="text-muted mb-0 small">Review and resolve active reports</p>
          </div>
          <div>
            <a href="#open-disputes" class="btn btn-sm btn-outline-warning">
              <i class="bi bi-arrow-down"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Search Form -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <%= form_with url: admin_users_path, method: :get, local: true, class: "row g-3" do |f| %>
      <div class="col-md-10">
        <%= f.label :search, "Search by username or email", class: "form-label fw-semibold" %>
        <%= f.text_field :search, value: params[:search], class: "form-control form-control-lg", placeholder: "Enter username or email..." %>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <%= f.submit "Search", class: "btn btn-primary btn-lg w-100" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Users Table -->
<% if @users.any? %>
  <div class="card shadow-sm border-0">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">Username</th>
              <th scope="col">Email</th>
              <th scope="col">Role</th>
              <th scope="col">Account Status</th>
              <th scope="col" class="text-center">Report Count</th>
              <th scope="col" class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @users.each do |user| %>
              <tr>
                <td>
                  <strong><%= user.username %></strong>
                </td>
                <td>
                  <small class="text-muted"><%= user.email %></small>
                </td>
                <td>
                  <span class="badge bg-<%= user.role == 'admin' ? 'danger' : user.role == 'owner' ? 'info' : 'success' %>">
                    <%= user.role.capitalize %>
                  </span>
                </td>
                <td>
                  <span class="badge bg-<%= user.account_status == 'active' ? 'success' : 'secondary' %>">
                    <i class="bi bi-<%= user.account_status == 'active' ? 'check-circle' : 'x-circle' %> me-1"></i>
                    <%= user.account_status.capitalize %>
                  </span>
                </td>
                <td class="text-center">
                  <% if user.report_count > 0 %>
                    <span class="badge bg-warning text-dark">
                      <i class="bi bi-flag me-1"></i><%= user.report_count %>
                    </span>
                  <% else %>
                    <span class="text-muted">0</span>
                  <% end %>
                </td>
                <td class="text-end">
                  <%= link_to admin_user_path(user), class: "btn btn-sm btn-outline-primary" do %>
                    <i class="bi bi-eye me-1"></i>View Details
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
<% else %>
  <div class="card shadow-sm border-0">
    <div class="card-body text-center py-5">
      <i class="bi bi-inbox display-1 text-muted mb-3"></i>
      <h4 class="text-muted">No users found</h4>
      <p class="text-muted">Try adjusting your search criteria.</p>
    </div>
  </div>
<% end %>

<!-- Open Disputes -->
<div id="open-disputes" class="card shadow-sm border-0 mt-5">
  <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
    <div>
      <h5 class="mb-0 fw-bold">
        <i class="bi bi-flag text-warning me-2"></i>Open Reports
      </h5>
      <small class="text-muted">Latest 25 open reports</small>
    </div>
    <span class="badge bg-warning text-dark"><%= @open_disputes.size %> open</span>
  </div>
  <div class="card-body">
    <% if @open_disputes.any? %>
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Item</th>
              <th>Reporter</th>
              <th>Reason</th>
              <th>Submitted</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @open_disputes.each do |dispute| %>
              <tr data-dispute-id="<%= dispute.id %>">
                <td>
                  <% if dispute.item.present? %>
                    <%= link_to dispute.item.title, item_path(dispute.item), class: "text-decoration-none" %>
                    <br>
                    <small class="text-muted">Owner: <%= dispute.item.owner.username %></small>
                  <% else %>
                    <span class="text-muted">Item removed</span>
                  <% end %>
                </td>
                <td><%= dispute.created_by.username %></td>
                <td><%= dispute.reason %></td>
                <td><small class="text-muted"><%= dispute.created_at.strftime("%b %d, %Y") %></small></td>
                <td class="text-end">
                  <div class="btn-group">
                    <button class="btn btn-sm btn-outline-success resolve-dispute" data-disable="false" data-dispute-id="<%= dispute.id %>">
                      Resolve
                    </button>
                    <button class="btn btn-sm btn-outline-danger resolve-dispute" data-disable="true" data-dispute-id="<%= dispute.id %>">
                      Resolve & Disable Owner
                    </button>
                  </div>
                  <textarea class="form-control form-control-sm mt-2 resolution-notes" rows="2" placeholder="Resolution notes (optional)"></textarea>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center text-muted py-4">
        <i class="bi bi-flag display-5 d-block mb-2"></i>
        No open reports.
      </div>
    <% end %>
  </div>
</div>

<!-- Recent Resolved Disputes -->
<div class="card shadow-sm border-0 mt-4">
  <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
    <div>
      <h6 class="mb-0 fw-bold">
        <i class="bi bi-check2-circle text-success me-2"></i>Recently Resolved
      </h6>
      <small class="text-muted">Latest 10 resolutions</small>
    </div>
  </div>
  <div class="card-body">
    <% if @resolved_disputes.any? %>
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Item</th>
              <th>Reporter</th>
              <th>Status</th>
              <th>Resolution</th>
            </tr>
          </thead>
          <tbody>
            <% @resolved_disputes.each do |dispute| %>
              <tr>
                <td>
                  <% if dispute.item.present? %>
                    <%= link_to dispute.item.title, item_path(dispute.item), class: "text-decoration-none" %>
                  <% else %>
                    <span class="text-muted">Item removed</span>
                  <% end %>
                </td>
                <td><%= dispute.created_by.username %></td>
                <td>
                  <span class="badge bg-success">
                    Resolved
                  </span>
                  <br>
                  <small class="text-muted">by <%= dispute.resolved_by&.username || "Admin" %></small>
                </td>
                <td>
                  <% if dispute.resolution_notes.present? %>
                    <small><%= dispute.resolution_notes %></small>
                  <% else %>
                    <small class="text-muted">No notes</small>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center text-muted py-3">
        <i class="bi bi-inbox mb-2"></i><br>No recent resolutions.
      </div>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const token = document.querySelector("meta[name='csrf-token']")?.content;
    document.querySelectorAll(".resolve-dispute").forEach((btn) => {
      btn.addEventListener("click", async (e) => {
        e.preventDefault();
        const disputeId = btn.dataset.disputeId;
        const disableAccount = btn.dataset.disable === "true";
        const notes = btn.closest("td").querySelector(".resolution-notes")?.value || "";
        btn.disabled = true;
        try {
          const res = await fetch(`/api/v1/admin/disputes/${disputeId}/resolve`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": token,
              "Accept": "application/json"
            },
            body: JSON.stringify({ resolution_notes: notes, disable_account: disableAccount })
          });
          const data = await res.json();
          if (res.ok && data.success) {
            alert("Report resolved successfully.");
            window.location.reload();
          } else {
            alert(data.error || "Failed to resolve report.");
          }
        } catch (err) {
          alert("Network error while resolving report.");
        } finally {
          btn.disabled = false;
        }
      });
    });
  });
</script>

